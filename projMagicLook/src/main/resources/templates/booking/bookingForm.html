<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="fragments/navbar :: head(~{::title})">
    <title>Reservar Item - MagicLook</title>
</head>
<body>
    <div th:replace="fragments/navbar :: navbar"></div>
    
    <style>
        .content-wrapper {
            padding-top: 100px;
            min-height: calc(100vh - 100px);
        }
        
        .magic-card {
            border-radius: 15px;
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        
        .btn-magic {
            background-color: #b8860b;
            border-color: #b8860b;
            color: white;
        }
        
        .btn-magic:hover {
            background-color: #8b6f3d;
            border-color: #8b6f3d;
        }

        .calendar-wrapper {
            margin: 20px 0;
            width: 100%;
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            gap: 15px;
        }

        .calendar-header button {
            background: #b8860b;
            border: none;
            color: white;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            flex-shrink: 0;
        }

        .calendar-header button:hover {
            background: #8b6f3d;
        }

        .calendar-header h5 {
            margin: 0;
            color: #b8860b;
            flex: 1;
            text-align: center;
            min-width: 150px;
        }

        .calendar-grid {
            display: grid !important;
            grid-template-columns: repeat(7, 1fr) !important;
            gap: 8px !important;
            margin-bottom: 20px !important;
            width: 100% !important;
            padding: 0 !important;
            box-sizing: border-box !important;
            list-style: none !important;
        }

        .day-header {
            text-align: center;
            font-weight: bold;
            color: #b8860b;
            padding: 8px 4px !important;
            background: #f0f0f0;
            border-radius: 5px;
            font-size: 0.9rem;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            margin: 0 !important;
            border: none !important;
        }

        .calendar-day {
            min-height: 50px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            border: 2px solid #e0e0e0 !important;
            border-radius: 5px !important;
            cursor: pointer !important;
            font-weight: 600 !important;
            transition: all 0.2s ease !important;
            background: white !important;
            user-select: none !important;
            padding: 0 !important;
            margin: 0 !important;
            min-width: 0 !important;
            box-sizing: border-box !important;
            font-size: 14px !important;
        }

        .calendar-day:hover:not(.disabled):not(.empty) {
            border-color: #0066cc !important;
            background: rgba(0, 102, 204, 0.15) !important;
            transform: translateY(-2px);
        }

        .calendar-day.empty {
            border: none !important;
            background: transparent !important;
            cursor: default !important;
        }

        .calendar-day.disabled {
            background: #b4b4b4 !important;
            color: white !important;
            cursor: not-allowed !important;
            border-color: #b4b4b4 !important;
            font-weight: bold !important;
        }

        .calendar-day.selected {
            background: #0066cc !important;
            color: white !important;
            border-color: #0052a3 !important;
            box-shadow: 0 2px 8px rgba(0, 102, 204, 0.4) !important;
        }

        .calendar-day.in-range {
            background: #3399ff !important;
            color: white !important;
            border-color: #0066cc !important;
        }

        .calendar-day.today {
            border: 2px solid #28a745;
            color: #28a745;
            font-weight: bold;
        }

        .selected-dates {
            background: #fff9e6;
            border: 2px solid #ffecb5;
            border-radius: 8px;
            padding: 12px;
            margin: 15px 0;
            text-align: center;
            display: none;
        }

        .selected-dates.show {
            display: block;
        }

        .selected-dates strong {
            color: #b8860b;
        }

        .item-image-container {
            width: 100%;
            max-height: 500px;
            overflow: hidden;
            border-radius: 10px;
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .item-image-container img {
            width: 75%;
            height: auto;
            max-height: 500px;
            object-fit: cover;
        }

        .no-image-placeholder {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            margin-bottom: 15px;
        }

        .no-image-placeholder i {
            font-size: 4rem;
            color: #ccc;
        }
    </style>

    <div class="container content-wrapper">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3 mb-0">
                <i class="bi bi-calendar-plus text-warning"></i> Reservar Item
            </h1>
        </div>
        
        <!-- Mensagem de erro se houver -->
        <div th:if="${error}" class="alert alert-danger" role="alert">
            <i class="bi bi-exclamation-triangle"></i> <span th:text="${error}"></span>
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <!-- Informações do Item -->
                <div class="card magic-card mb-4">
                    <div class="card-body">
                        <!-- Item Image -->
                        <div class="item-image-container" th:if="${item.imagePath != null and not item.imagePath.isEmpty()}">
                            <img th:src="@{${item.imagePath}}" th:alt="${item.name}" class="img-fluid">
                        </div>
                        
                        <h4 th:text="${item.name}"></h4>
                        <div class="row mt-3">
                            <div class="col-6">
                                <p><strong class="text-warning">Preço de aluguer:</strong><br>
                                   <span class="h4">€<span th:text="${item.priceRent}"></span></span>/dia</p>
                            </div>
                        </div>
                        <hr>
                        <p><strong>Marca:</strong> <span th:text="${item.brand}"></span></p>
                        <p><strong>Cor:</strong> <span th:text="${item.color}"></span></p>
                        <p><strong>Material:</strong> <span th:text="${item.material}"></span></p>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <!-- Formulário -->
                <div class="card magic-card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0">
                            <i class="bi bi-calendar-date"></i> Datas da Reserva
                        </h5>
                    </div>
                    <div class="card-body">
                        <form th:action="@{/magiclook/booking/create}" method="post" id="bookingForm">
                            <input type="hidden" name="itemId" th:value="${item.itemId}" />
                            <input type="hidden" name="startUseDate" id="startUseDateInput" />
                            <input type="hidden" name="endUseDate" id="endUseDateInput" />
                            
                            <!-- Tamanho PRIMEIRO -->
                            <div class="mb-3" th:if="${not availableSizes.empty}">
                                <label for="size" class="form-label">
                                    Selecione o Tamanho*
                                </label>
                                <select name="size" id="size" class="form-control" required onchange="onSizeChange()">
                                    <option value="">-- Escolher tamanho --</option>
                                    <option th:each="sizeOpt : ${availableSizes}" 
                                            th:value="${sizeOpt}" 
                                            th:text="${sizeOpt}">
                                    </option>
                                </select>
                            </div>

                            <div class="mb-3" th:unless="${not availableSizes.empty}">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i> Este item não possui opções de tamanho.
                                    <input type="hidden" name="size" value="" />
                                </div>
                            </div>
                            
                            <!-- Calendário (escondido até selecionar tamanho) -->
                            <div id="calendarSection" style="display: none;">
                                <label class="form-label fw-bold mt-4">
                                    <i class="bi bi-calendar-check"></i> Selecione as Datas
                                </label>
                                <div class="calendar-wrapper">
                                    <div class="calendar-header">
                                        <button type="button" onclick="previousMonth()">&larr;</button>
                                        <h5 id="monthYear"></h5>
                                        <button type="button" onclick="nextMonth()">&rarr;</button>
                                    </div>
                                    <div id="calendar" class="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; width: 100%; padding: 0; margin: 0;"></div>
                                    <div id="selectedDatesDisplay" class="selected-dates">
                                        <p>De <strong id="dateStart"></strong> até <strong id="dateEnd"></strong></p>
                                        <p style="font-size: 0.9rem; color: #666;"><span id="dayCount"></span> dias</p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2 mt-4">
                                <button type="submit" class="btn btn-magic" id="submitBtn" disabled>
                                    <i class="bi bi-calendar-check"></i> Confirmar Reserva
                                </button>
                                <a href="javascript:history.back()" class="btn btn-outline-secondary">
                                    <i class="bi bi-x-circle"></i> Cancelar
                                </a>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="alert alert-info mt-4">
            <h6><i class="bi bi-info-circle"></i> Como funciona a reserva:</h6>
            <ul class="mb-0">
                <li>Período total da reserva = <strong>1 dia antes</strong> + <strong>dias de uso</strong> + <strong>1 dia depois</strong></li>
                <li>Você só paga pelos <strong>dias de uso efectivo</strong></li>
                <li>Exemplo: 2 dias de uso = 4 dias reservados, paga 2 diárias</li>
            </ul>
        </div>
    </div>

    <script>
        const itemId = [[${item.itemId}]];
        const monthNames = ['Janeiro', 'Fevereiro', 'Março', 'Abril', 'Maio', 'Junho',
                           'Julho', 'Agosto', 'Setembro', 'Outubro', 'Novembro', 'Dezembro'];
        const dayNames = ['Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb', 'Dom'];
        
        let currentMonth = new Date();
        let startDate = null;
        let endDate = null;
        let unavailableDates = [];
        let selectedSize = null;

        document.addEventListener('DOMContentLoaded', function() {
            // Renderizar o calendário inicial (primeiro mês)
            currentMonth = new Date();
        });

        function onSizeChange() {
            selectedSize = document.getElementById('size').value;
            
            if (!selectedSize) {
                // Se deselecionar, esconder o calendário e limpar seleções
                document.getElementById('calendarSection').style.display = 'none';
                startDate = null;
                endDate = null;
                unavailableDates = [];
                updateDisplay();
                return;
            }

            // Mostrar calendário, limpar seleções anteriores e buscar datas indisponíveis
            document.getElementById('calendarSection').style.display = 'block';
            startDate = null;
            endDate = null;
            updateDisplay();
            fetchUnavailableDatesForSize();
        }

        async function fetchUnavailableDatesForSize() {
            try {
                const response = await fetch(`/magiclook/api/availability?itemId=${itemId}&size=${encodeURIComponent(selectedSize || '')}`);
                if (response.ok) {
                    const data = await response.json();
                    unavailableDates = (data.unavailableDates || []).map(d => {
                        // Garantir formato YYYY-MM-DD
                        return d.includes('T') ? d.split('T')[0] : d;
                    });
                    console.log('%c✅ Datas indisponíveis carregadas para tamanho ' + selectedSize, 'color: green; font-weight: bold; font-size: 14px;');
                    console.log('%cArray:', 'color: green; font-weight: bold;', unavailableDates);
                } else {
                    console.log('%c⚠️ Sem datas indisponíveis para este tamanho', 'color: orange; font-weight: bold;');
                    unavailableDates = [];
                }
            } catch (error) {
                console.error('%c❌ Erro ao buscar disponibilidade:', 'color: red; font-weight: bold;', error);
                unavailableDates = [];
            }
            renderCalendar();
        }

        function renderCalendar() {
            const year = currentMonth.getFullYear();
            const month = currentMonth.getMonth();
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0).getDate();
            const startingDayOfWeek = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;

            document.getElementById('monthYear').textContent = `${monthNames[month]} ${year}`;

            let html = '';

            // Cabeçalhos dos dias da semana
            for (let day of dayNames) {
                html += `<div class="day-header" style="text-align: center; font-weight: bold; color: #b8860b; padding: 8px 4px; background: #f0f0f0; border-radius: 5px; font-size: 0.9rem; display: flex; align-items: center; justify-content: center; margin: 0; border: none; grid-column: span 1;">${day}</div>`;
            }

            // Espaços vazios no início
            for (let i = 0; i < startingDayOfWeek; i++) {
                html += `<div class="calendar-day empty" style="border: none; background: transparent; cursor: default; grid-column: span 1;"></div>`;
            }

            // Dias do mês
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            for (let day = 1; day <= lastDay; day++) {
                const date = new Date(year, month, day);
                const dateStr = date.toISOString().split('T')[0];
                let classes = 'calendar-day';
                let styles = 'min-height: 50px; display: flex; align-items: center; justify-content: center; border: 2px solid #e0e0e0; border-radius: 5px; cursor: pointer; font-weight: 600; transition: all 0.2s ease; background: white; user-select: none; padding: 0; margin: 0; box-sizing: border-box; font-size: 14px; grid-column: span 1;';

                // Verificar se está desabilitado (passado ou sem disponibilidade)
                const isPast = date < today;
                const isUnavailable = unavailableDates.includes(dateStr);
                const isDisabled = isPast || isUnavailable;
                
                if (isDisabled) {
                    classes += ' disabled';
                    // styles += ' background: #ff0000 !important; color: white !important; border-color: #cc0000 !important; cursor: not-allowed !important;';
                    if (day <= 5) console.log(`Data ${dateStr}: past=${isPast}, unavailable=${isUnavailable}, array=${JSON.stringify(unavailableDates.slice(0, 3))}`);
                } else if (date.toDateString() === today.toDateString()) {
                    classes += ' today';
                }

                // Verificar seleção
                if (startDate && endDate) {
                    if (date.getTime() === startDate.getTime() || date.getTime() === endDate.getTime()) {
                        classes += ' selected';
                        styles += ' background: #0066cc !important; color: white !important; border-color: #0052a3 !important;';
                    } else if (date > startDate && date < endDate) {
                        classes += ' in-range';
                        styles += ' background: #3399ff !important; color: white !important; border-color: #0066cc !important;';
                    }
                } else if (startDate && date.getTime() === startDate.getTime()) {
                    classes += ' selected';
                    styles += ' background: #0066cc !important; color: white !important; border-color: #0052a3 !important;';
                }

                html += `<div class="${classes}" style="${styles}" onclick="selectDate('${dateStr}')">${day}</div>`;
            }

            const calendarElement = document.getElementById('calendar');
            calendarElement.innerHTML = html;
            
            // Forçar grid layout no elemento
            calendarElement.style.display = 'grid';
            calendarElement.style.gridTemplateColumns = 'repeat(7, 1fr)';
            calendarElement.style.gap = '8px';
            calendarElement.style.width = '100%';
            calendarElement.style.padding = '0';
            calendarElement.style.margin = '0';
        }

        function previousMonth() {
            currentMonth.setMonth(currentMonth.getMonth() - 1);
            renderCalendar();
        }

        function nextMonth() {
            currentMonth.setMonth(currentMonth.getMonth() + 1);
            renderCalendar();
        }

        function selectDate(dateStr) {
            const date = new Date(dateStr + 'T00:00:00');

            if (!startDate) {
                startDate = new Date(date);
                endDate = null;
            } else if (!endDate) {
                if (date < startDate) {
                    endDate = startDate;
                    startDate = new Date(date);
                } else if (date.getTime() === startDate.getTime()) {
                    startDate = null;
                } else {
                    endDate = new Date(date);
                }
            } else {
                startDate = new Date(date);
                endDate = null;
            }

            renderCalendar();
            updateDisplay();
        }

        function updateDisplay() {
            const display = document.getElementById('selectedDatesDisplay');
            
            if (startDate && endDate) {
                const start = new Date(startDate);
                const end = new Date(endDate);
                const days = Math.ceil((end - start) / (1000 * 60 * 60 * 24)) + 1;

                document.getElementById('dateStart').textContent = start.toLocaleDateString('pt-PT');
                document.getElementById('dateEnd').textContent = end.toLocaleDateString('pt-PT');
                document.getElementById('dayCount').textContent = days;

                document.getElementById('startUseDateInput').value = startDate.toISOString().split('T')[0];
                document.getElementById('endUseDateInput').value = endDate.toISOString().split('T')[0];

                display.classList.add('show');
                document.getElementById('submitBtn').disabled = false;
            } else {
                display.classList.remove('show');
                document.getElementById('submitBtn').disabled = true;
                document.getElementById('startUseDateInput').value = '';
                document.getElementById('endUseDateInput').value = '';
            }
        }
    </script>
</body>
</html>